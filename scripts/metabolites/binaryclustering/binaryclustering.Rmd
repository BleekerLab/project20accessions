---
title: "Clustering of binary variables"
author: "Marc Galland"
date: "`r Sys.Date()`"
output:
    html_document:
        number_sections: yes
        toc: yes
        toc_depth: 2
        keep_md: true
params:
  data: "inputdata/20160916_acylsugars.txt"
  species: "../../../data/accession2species.txt"
---
#    data: 
#    species: "../../../data/accession2species.txt"
#data:
#label: "input dataset"
#value: inputdata/20160902terpenoids.txt" -->
#input: file 

# Setup

## Knitr
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries
```{r Load libraries}
library(ggplot2)
library(ade4)
library(ggdendro)
```

## result directory
```{r}
dir.create("results",showWarnings = F)
```

## Load data
```{r Load data}
# check file extension to load file
if (tools::file_ext(params$data) == "csv"){
  df = read.csv(params$data,header = T,stringsAsFactors = F)
} else if (tools::file_ext(params$data) == "txt") {
    df = read.delim(params$data,header=T,stringsAsFactors = F)
} else {
    print("input data needs to be comma-separated (.csv) or tabulated (.txt)")
  }
```

## load species/accession
```{r species accession correspondence}
accession2species = read.delim(params$species,header = T,sep="\t",stringsAsFactors = F)
```

## replace values > 0 by 1
```{r replace values above zero by 1}

# util function
replacebyone <- function(x) {
  if (x > 0){
    x <- 1
} else if (x == 0) {
    x <- 0
} else {
    print("you have a problem in your input data (should be 0 or positive values")
  }
}


# make df binary (0 or 1) by applying it to the whole matrix
mat = apply(as.matrix(df[,2:ncol(df)]),MARGIN = 1:2,FUN = replacebyone)
row.names(mat)=df$accession
```

# Dendrograms
```{r}
# select method for distance calculation 
# 1 = Jaccard (size of intersection/size of union)
dist = dist.binary(mat,method=1)

# hierarchical clustering  
hclust.mat = hclust(dist,method = "average")

# plot using base graph
maxy = round(max(hclust.mat$height) + 0.1*max(hclust.mat$height),digits = 1)
plot(hclust.mat,ylab = "Jaccard distance",xlab = "Accessions")

#save
svg(filename = file.path("results/","dendogram.svg"))
plot(hclust.mat,ylab = "Jaccard distance",xlab = "Accessions",ylim=c(0,maxy))
dev.off()

# 
# # data extraction from dendrogram
# # plot using ggdendro
# # plot using ggplot2
# ddata = dendro_data(as.dendrogram(hclust.mat))
# p <- ggplot(segment(ddata)) + 
#   geom_segment(aes(x=x,y=y,xend=xend,yend=yend)) +
#   coord_flip() 
# #  geom_text(mapping = aes(x,y,label=labels),data = ddata) +
#  # coord_flip()
# print(p)
```


